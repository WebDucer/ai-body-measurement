<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:BodyMeasurement.ViewModels"
             xmlns:resources="clr-namespace:BodyMeasurement.Resources.Strings"
             x:Class="BodyMeasurement.Views.MainPage"
             x:DataType="viewModels:MainViewModel"
             Title="{x:Static resources:Strings.MainPageTitle}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="{x:Static resources:Strings.AddWeightButton}"
                     Command="{Binding NavigateToAddWeightCommand}"
                     IconImageSource="{FontImage Glyph='+', Color=White, Size=22}" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*">
        
        <!-- Statistics Summary Header -->
        <Border Grid.Row="0"
                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2C2C2C}"
                Padding="16"
                Margin="16,16,16,8">
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
                
                <!-- Current Weight -->
                <VerticalStackLayout Grid.Column="0">
                    <Label Text="{x:Static resources:Strings.CurrentWeight}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           HorizontalOptions="Center" />
                    <Label Text="{Binding CurrentWeight, StringFormat='{0:F1}'}"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           IsVisible="{Binding CurrentWeight, Converter={StaticResource IsNotNullConverter}}" />
                    <Label Text="--"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           IsVisible="{Binding CurrentWeight, Converter={StaticResource IsNullConverter}}" />
                </VerticalStackLayout>

                <!-- Starting Weight -->
                <VerticalStackLayout Grid.Column="1">
                    <Label Text="{x:Static resources:Strings.StartingWeight}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           HorizontalOptions="Center" />
                    <Label Text="{Binding StartingWeight, StringFormat='{0:F1}'}"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           IsVisible="{Binding StartingWeight, Converter={StaticResource IsNotNullConverter}}" />
                    <Label Text="--"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           IsVisible="{Binding StartingWeight, Converter={StaticResource IsNullConverter}}" />
                </VerticalStackLayout>

                <!-- Weight Change -->
                <VerticalStackLayout Grid.Column="2">
                    <Label Text="{x:Static resources:Strings.WeightChange}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           HorizontalOptions="Center" />
                    <Label FontSize="18"
                           FontAttributes="Bold"
                           HorizontalOptions="Center">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="{Binding WeightChangeAbsolute, StringFormat='{0:+0.0;-0.0;0}'}" />
                                <Span Text=" " />
                                <Span Text="{Binding PreferredUnit}" />
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                </VerticalStackLayout>
            </Grid>
        </Border>

        <!-- Weight Entries List -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding LoadWeightEntriesCommand}">
            
            <CollectionView ItemsSource="{Binding WeightEntries}"
                           EmptyView="No measurements yet. Tap + to add your first entry."
                           SelectionMode="None">
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="{x:Null}">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Edit"
                                              BackgroundColor="#2196F3"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:MainViewModel}}, Path=NavigateToEditWeightCommand}"
                                              CommandParameter="{Binding Id}" />
                                    <SwipeItem Text="Delete"
                                              BackgroundColor="#F44336"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:MainViewModel}}, Path=DeleteWeightEntryCommand}"
                                              CommandParameter="{Binding Id}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Border Margin="16,8"
                                   Padding="16"
                                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                   StrokeThickness="1"
                                   Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#3C3C3C}">
                                <Grid ColumnDefinitions="*,Auto">
                                    
                                    <!-- Left: Date and Notes -->
                                    <VerticalStackLayout Grid.Column="0">
                                        <Label Text="{Binding Date, StringFormat='{0:MMM dd, yyyy}'}"
                                               FontSize="16"
                                               FontAttributes="Bold" />
                                        <Label Text="{Binding Notes}"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                               IsVisible="{Binding Notes, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                                    </VerticalStackLayout>

                                    <!-- Right: Weight -->
                                    <Label Grid.Column="1"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding WeightKg, StringFormat='{0:F1}'}" />
                                                <Span Text=" kg" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
        
        <!-- Floating Action Button -->
        <Button Grid.Row="1"
                Text="+"
                FontSize="32"
                Command="{Binding NavigateToAddWeightCommand}"
                WidthRequest="60"
                HeightRequest="60"
                CornerRadius="30"
                BackgroundColor="{AppThemeBinding Light=#2196F3, Dark=#1976D2}"
                TextColor="White"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,20,20"
                Shadow="{Shadow Brush=Black, Opacity=0.3, Radius=8, Offset='0,4'}">
        </Button>
    </Grid>

</ContentPage>
