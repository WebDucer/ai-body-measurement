name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore BodyMeasurement.Tests/BodyMeasurement.Tests.csproj
      
    - name: Build test project
      run: dotnet build BodyMeasurement.Tests/BodyMeasurement.Tests.csproj --configuration Release --no-restore
      
    - name: Run tests with coverage
      run: dotnet test BodyMeasurement.Tests/BodyMeasurement.Tests.csproj --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage
      
    - name: Generate coverage report
      uses: danielpalme/ReportGenerator-GitHub-Action@5.4.2
      with:
        reports: 'coverage/**/coverage.cobertura.xml'
        targetdir: 'coveragereport'
        reporttypes: 'HtmlInline;Cobertura;TextSummary'
        
    - name: Display coverage summary
      run: cat coveragereport/Summary.txt
      
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coveragereport/
        retention-days: 30
        
    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: coverage/
        retention-days: 7

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install .NET MAUI workload
      run: dotnet workload install maui-android
      
    - name: Restore dependencies
      run: dotnet restore BodyMeasurement/BodyMeasurement.csproj
      
    - name: Build Android app
      run: dotnet build BodyMeasurement/BodyMeasurement.csproj -f net10.0-android --configuration Release --no-restore
      
    - name: Upload Android build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: BodyMeasurement/bin/Release/net10.0-android/
        retention-days: 7

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install .NET MAUI workload
      run: dotnet workload install maui
      
    - name: Restore dependencies
      run: dotnet restore BodyMeasurement/BodyMeasurement.csproj -r win-x64
      
    - name: Build Windows app
      run: dotnet build BodyMeasurement/BodyMeasurement.csproj -f net10.0-windows10.0.19041.0 --configuration Release --no-restore
      
    - name: Upload Windows build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: BodyMeasurement/bin/Release/net10.0-windows10.0.19041.0/
        retention-days: 7

  build-macos:
    name: Build macOS and iOS
    runs-on: macos-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Select Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.x'
        
    - name: Install .NET MAUI workload
      run: dotnet workload install maui
      
    - name: Restore dependencies
      run: dotnet restore BodyMeasurement/BodyMeasurement.csproj
      
    - name: Build iOS app
      run: dotnet build BodyMeasurement/BodyMeasurement.csproj -f net10.0-ios --configuration Release --no-restore
      
    - name: Build macCatalyst app
      run: dotnet build BodyMeasurement/BodyMeasurement.csproj -f net10.0-maccatalyst --configuration Release --no-restore
      
    - name: Upload iOS build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: BodyMeasurement/bin/Release/net10.0-ios/
        retention-days: 7
        
    - name: Upload macOS build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: BodyMeasurement/bin/Release/net10.0-maccatalyst/
        retention-days: 7

  check-coverage:
    name: Check Code Coverage
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Download coverage report
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        
    - name: Check coverage threshold
      run: |
        # Extract line coverage percentage from Cobertura report
        coverage=$(grep -oP 'line-rate="\K[0-9.]+' Cobertura.xml | head -1)
        coverage_percent=$(echo "$coverage * 100" | bc)
        echo "Line coverage: $coverage_percent%"
        
        # Check if coverage meets 80% threshold
        threshold=80
        if (( $(echo "$coverage_percent < $threshold" | bc -l) )); then
          echo "❌ Coverage $coverage_percent% is below threshold $threshold%"
          exit 1
        else
          echo "✅ Coverage $coverage_percent% meets threshold $threshold%"
        fi
